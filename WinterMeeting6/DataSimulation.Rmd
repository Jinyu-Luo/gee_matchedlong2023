---
title: "Modeling longitudinal outcomes in a matched-pair cohort with application to cardiovascular data"
subtitle: "Simulation Phase"
author: "Jinyu Luo"
date: "2024-02-13"
output: 
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    theme: yeti
    highlight: haddock
  pdf_document:
    toc: yes
    toc_depth: '2'
    keep_tex: false
---

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
div.yellow { background-color:#fffde6; border-radius: 5px; padding: 20px;}
div.green { background-color:#e6fff0; border-radius: 5px; padding: 20px;}
div.orange { background-color:#ffede6; border-radius: 5px; padding: 20px;}
div.purple { background-color:#f5e6ff; border-radius: 5px; padding: 20px;}
div.aqua { background-color:#e6fdff; border-radius: 5px; padding: 20px;}
</style>


## Weekly Summary 

### Completed Items 

* Generated all covariates for 250 patients, with each has 10 observations. 
* Generated the outcome variable for each visit per patient. 
* Fitted GEE with exchangeable structure to the full data using n = 250. 
* Performed propensity score matching. 
* Fitted GEE with the matched data. 

### Questions 

1. How to select value for the common correlation $\rho$?
2. Is it correct to assume age and BSA to be constant over time?
3. How to control the interval between each visit?

\newpage 

```{r setup, include=FALSE}
# install.packages(c("here","PupillometryR", "AICcmodavg", "contrast"))
library(here)
library(tinytex)
library(PupillometryR)
library(knitr)
library(nlme)
library(car)
library(AICcmodavg)
library(contrast)
library(tidyverse)    # all things tidy
library(pander)       # nice looking genderal tabulations
library(furniture)    # nice table1() descriptives
library(texreg)       # Convert Regression Output to LaTeX or HTML Tables
library(psych)        # contains some useful functions, like headTail

library(interactions)
library(performance)
library(lme4)         # Linear, generalized linear, & nonlinear mixed models

library(corrplot)     # Vizualize correlation matrix
library(gee)          # Genderalized Estimation Equation Solver
library(geepack)      # Genderalized Estimation Equation Package 
library(MuMIn)        # Multi-Model Inference (caluclate QIC)

library(CorBin)
library(parallel)

# remotes::install_github("sarbearschwartz/texreghelpr")
library(texreghelpr)  # Helper extract functions for exponentiation of parameters form generalized regression models within a texreg table of model parameters.

knitr::opts_knit$set(root.dir = here())
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Use black/white theme and increase font size for all ggplot figures
theme_set(theme_bw(base_size = 15)) 
```


## Covariates and Outcome Generation 

* `male` $\sim$ Binomial (size = 1, prob = 0.65, n = 250) using #rbinom.
* `age` $\sim$ rnorm(n=250, mean = 60, sd = 10)
* `BSA` $\sim$ rnorm(n=250, mean = 2, sd =0.2) 
* `BAV`:
$$
\text{logit Pr}(BAV=1) = -0.4-0.1\times \text{Age} + 1.2\times \text{male} + 3\times \text{BSA} = m
$$
where Pr$(BAV=1) = \frac{\exp(m)}{1+\exp(m)}$ represents the propensity score. 

Then, the outcome variable depends on 
$$
\text{logit Pr}(Y=1) = -1 -0.05\times \text{visit} - 2\times \text{BAV} - 0.05 \text{Age} + 1.5 \times \text{Male} + 0.5 \times \text{BSA} + 0.5 \times \text{Visit} \times \text{BAV}
$$

* Generate 500 patients, with each has 10 visits. So, the simulated data is expected to have 5000 rows. 
* Set the correlation to be 0.05, because it will be out of bound if setting it to be 0.3

```{r, echo=FALSE}
args <- (commandArgs(TRUE))
print(args)
if(length(args) == 0){
  print("No arguments supplied.")
  
  ## supply default values
  N <- 500 # N = 50, 250, 500
  beta0 <- log(0.1) #-2.303
  beta1 <- log(2) # 0.6931
  rho <- 0.05   # 0.05, 0.3
  simnum <- 1000 #1000
}else{
  for (i in (1:length(args))) eval(parse(text=args[[i]]))
}
set.seed(4936457)
simlist <- list()
for(i in 1:N){
  male <- rbinom(1, size = 1, prob = 0.65)
  age <- rnorm(1, mean = 60, sd = 10)
  BSA <- rnorm(1, mean = 2, sd = 0.2)
  
  # Calculate the logit for Pr(BAV=1)
  logit_bav <- -0.4 - 0.1 * age + 1.2 * male + 3 * BSA
  prob_BAV <- exp(logit_bav) / (1 + exp(logit_bav)) # probability of outcome for person i
  # Simulate BAV outcome based on calculated probabilities
  BAV <- rbinom(1, size = 1, prob = prob_BAV)
  
  ni <- 10 # number of visits per person
  visit <- 1:10
  logit_y <- -1 - 0.05*visit-2*BAV-0.05*age+1.5*male+0.5*BSA+0.5*BAV*visit
  prob_y <- exp(logit_y)/(1+exp(logit_y))
  y <- cBern(n = 1, p = prob_y, rho = rho, type = "exchange") # generate outcome of ni timepoints
  
  # prob_y <- exp(logit_yi)/(1+exp(logit_yi))
  # y <- cBern(n = ni, p = prob_y, rho = rho, type = "exchange") # generate outcome of ni timepoints
  datai <- cbind(rep(i, ni), c(1:ni), as.numeric(t(y)), rep(BAV, ni), 
                 rep(male, ni), rep(age, ni), rep(BSA, ni))
  simlist[[i]] <- datai
}
simdata <- as.data.frame(as.matrix(do.call("rbind", simlist)))
names(simdata) <- c("id", "visit", "y", "BAV", "male", "age", "bsa")
head(simdata) %>% kable(booktabs = TRUE, digits = 2, 
                        caption = "The First 6 rows of the Simulated Data")
```

## EDA (Unmatched Data)

* The TAV group has relatively more balanced sex distribution, with 44% of female and 56% of males. However, the sex distribution is not balanced in the BAV group where males take the majority account, around 74%. 
* The mean age of the TAV group is almost 10 years older compared to the BAV group (around 56.4). 
* The BSA are similar across the two groups. 
* The proportion of outcome in the TAV group is slightly higher than the proportion in the BAV group, 9.1% compared to 5.7%. 

```{r}
eda_df <- simdata %>% 
  group_by(id) %>% 
  filter(visit == 1) %>% 
  mutate(y = factor(y, levels = c(0, 1)),
         BAV = factor(BAV, levels = c(0, 1), labels = c("TAV", "BAV")), 
         male = factor(male, levels = c(0, 1), labels = c("Female","Male"))) %>% 
  rename(Outcome = y, Age = age, Sex = male, BSA = bsa)
library(table1)
table1(~ Sex + Age + BSA + Outcome | BAV, 
       data=eda_df)
```

## GEE with Unmatched Data 

```{r}
unmatched_gee <- gee(y ~ BAV+ visit + age + male + bsa + BAV*visit,
                     data = simdata, family = binomial(link = "logit"), 
                     id = id, corstr = "exchangeable", scale.fix = TRUE, 
                     scale.value = 1)
```

## Propensity Score Matching 

```{r}
match_df <- simdata %>% 
  group_by(id) %>% 
  slice(1) 

library(optmatch)
# Step1: Estimate propensity scores with logistic regression
ps_model <- glm(y ~ age + male + bsa, family = binomial, data = match_df)
summary(ps_model)
```

```{r}
# Step2: Perform propensity score matching 
pps_match <- pairmatch(ps_model, data = match_df)
summary(pps_match) # 22 matched pairs and 54 unmatched patients
```
Observations: 

* Among 500 patients, only 76 patients are matched. 

```{r}
# Get the matched dataframe 
matched_df <- data.frame(match_df, matched = pps_match, 
                         check.rows = TRUE) %>% 
  filter(!is.na(matched))
```


```{r}
library(cobalt)
# Check Balance 
covs <- subset(match_df, select = c(age, male, bsa))
pps <- ps_model$fitted.values 
bal.tab(pps_match, covs = covs, distance = ~ pps)
```

### Create a Long data using only matched pairs 

After matching, 

* The sex distribution is similar between the exposure groups. 
* The proportion of positive outcome is increased to 64% in the TAV group, while the proportion for positive outcome is only about 36% in the BAV group. 

```{r}
matched_long <- simdata %>% 
  filter(id %in% matched_df$id) %>% 
  left_join(matched_df %>% select(id, matched), by = "id")
# saveRDS(matched_long,file="matched_data.rds")

matched_eda <- matched_long %>% 
  mutate(Outcome = factor(y, levels = c(0, 1)),
         BAV = factor(BAV, levels = c(0, 1), labels = c("TAV", "BAV")), 
         Sex = factor(male, levels = c(0, 1), labels = c("Female","Male"))) %>% 
  filter(visit == 1) %>% 
  rename(BSA = bsa, Age = age)

table1(~ Sex + Age + BSA + Outcome| BAV, 
       data=matched_eda)
```

Check the number of distinct patients
```{r}
n_distinct(matched_long$id)
```

## GEE with Matched Data

```{r}
matched_gee <- gee(y ~ visit + BAV + visit:BAV + age + male + bsa,
                   data = matched_long, family = binomial(link = "logit"),
                   id = id, corstr = "exchangeable",
                   scale.fix = TRUE, scale.value = 1)
```

